<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Gemini Manager</title>
    <script src="/static/js/tailwind.js"></script>
    <link rel="stylesheet" href="/static/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="/static/js/sortable.min.js"></script>
    <style>
        :root { --primary: #4f46e5; }
        body { background-color: #f1f5f9; font-family: 'Inter', system-ui, sans-serif; color: #0f172a; -webkit-font-smoothing: antialiased; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .spinner { width: 44px; height: 44px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .card-enter { animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        .tab-btn.active { border-bottom: 2px solid var(--primary); color: var(--primary); }
        .sortable-ghost { opacity: 0.4; background: #f1f5f9; border: 2px dashed #cbd5e1; }
		.custom-scrollbar::-webkit-scrollbar { width: 12px; }
		.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
		.custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-10">

    <nav class="glass-nav sticky top-0 z-50">
        <div class="container mx-auto px-6 h-20 flex justify-between items-center max-w-7xl">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <i class="fa-solid fa-layer-group text-lg"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-900">Gemini Manager</h1>
            </div>
            <div class="flex gap-8 text-base font-bold">
                <button onclick="switchTab('servers')" id="tab-servers" class="tab-btn active px-2 py-6 transition-colors">ä»£ç†æœåŠ¡ç®¡ç†</button>
                <button onclick="switchTab('quota')" id="tab-quota" class="tab-btn px-2 py-6 transition-colors text-slate-500 hover:text-slate-700">é¢åº¦ç›‘æ§</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-6 py-8 max-w-7xl">
        <div id="view-servers" class="space-y-8">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800">ä»£ç†æœåŠ¡åˆ—è¡¨</h2>
                <button onclick="showModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-sm transition-transform active:scale-95 flex items-center gap-2">
                    <i class="fa-solid fa-plus"></i>æ·»åŠ æœåŠ¡
                </button>
            </div>
            <div id="server-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="view-quota" class="hidden space-y-6">
            <div class="flex justify-between items-center">
				<div class="hidden md:flex items-center gap-6 text-sm font-medium text-slate-600 bg-white/80 px-5 py-2 rounded-full border border-slate-200 shadow-sm backdrop-blur-sm">
					<div class="flex items-center gap-2.5" title="æ¯æ—¥ä¸Šé™ï¼šæ™®é€š 100 / Proä¼šå‘˜ 250">
						<div class="w-6 h-6 rounded bg-indigo-50 flex items-center justify-center border border-indigo-100">
							<i class="fa-solid fa-star text-indigo-500 text-xs"></i>
						</div>
						<div class="flex flex-col leading-none gap-0.5">
							<span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Pro Model</span>
							<div class="font-mono font-bold">
								<span class="text-slate-700">100</span>
								<span class="text-slate-300 mx-0.5">/</span>
								<span class="bg-gradient-to-r from-indigo-500 to-purple-600 text-transparent bg-clip-text">250</span>
							</div>
						</div>
					</div>
					<span class="w-px h-6 bg-slate-200"></span>
					<div class="flex items-center gap-2.5" title="æ¯æ—¥ä¸Šé™ï¼šæ™®é€š 1000 / Proä¼šå‘˜ 1500">
						<div class="w-6 h-6 rounded bg-amber-50 flex items-center justify-center border border-amber-100">
							<i class="fa-solid fa-bolt text-amber-500 text-xs"></i>
						</div>
						<div class="flex flex-col leading-none gap-0.5">
							<span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Flash Model</span>
							<div class="font-mono font-bold">
								<span class="text-slate-700">1.0k</span>
								<span class="text-slate-300 mx-0.5">/</span>
								<span class="bg-gradient-to-r from-indigo-500 to-purple-600 text-transparent bg-clip-text">1.5k</span>
							</div>
						</div>
					</div>
				</div>
				<div class="flex items-center gap-4">
					<label class="flex items-center gap-2 cursor-pointer bg-white border border-slate-200 px-4 py-2 rounded-xl shadow-sm hover:bg-slate-50 transition-colors h-[46px]">
						<input type="checkbox" id="merge-toggle" onchange="toggleMerge(this.checked)" class="w-4 h-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500">
						<span class="text-sm font-bold text-slate-700 whitespace-nowrap">åˆå¹¶åŒç»„</span>
					</label>
					<button onclick="loadAllQuotas(true)" class="bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 font-bold px-6 py-2.5 rounded-xl text-sm shadow-sm transition-transform active:scale-95 flex items-center gap-2.5 h-[46px]">
						<i class="fa-solid fa-rotate-right text-indigo-600"></i> åˆ·æ–°
					</button>
				</div>
			</div>
            <div id="quota-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </main>

    <!-- Modal -->
    <div id="modal-add" class="fixed inset-0 bg-black/50 hidden items-center justify-center backdrop-blur-sm z-[100]">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800">æ·»åŠ é…ç½®</h3>
                <button type="button" onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <form id="server-form" onsubmit="handleFormSubmit(event)" autocomplete="off" class="space-y-5">
				<div>
					<label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">æœåŠ¡ç±»å‹</label>
					<div class="flex gap-4">
						<label class="flex items-center gap-2 cursor-pointer">
							<input type="radio" name="type" value="cli" checked onchange="handleTypeChange()" class="w-4 h-4 text-indigo-600">
							<span class="text-sm font-medium text-slate-700">Gemini CLI</span>
						</label>
						<label class="flex items-center gap-2 cursor-pointer">
							<input type="radio" name="type" value="antigravity" onchange="handleTypeChange()" class="w-4 h-4 text-indigo-600">
							<span class="text-sm font-medium text-slate-700">Google Antigravity</span>
						</label>
					</div>
				</div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">æœåŠ¡åç§°</label>
                    <input type="text" name="name" autocomplete="off" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all font-medium">
                </div>
                <div>
					<label id="token-path-label" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">å‡­è¯æ–‡ä»¶ (tokens/cli/)</label>
					<div class="flex gap-2">
						<div class="relative flex-1">
							<select name="token_file" id="token-select" required onchange="handleTokenChange()" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all appearance-none font-medium"></select>
							<i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
						</div>
						<button id="btn-login-google" type="button" onclick="loginGoogle()" class="px-4 py-3 bg-white border border-slate-200 text-indigo-600 rounded-xl hover:bg-indigo-50 transition-colors flex items-center gap-2 font-bold whitespace-nowrap"><i class="fa-brands fa-google"></i> ç™»å½•æ·»åŠ </button>
					</div>
				</div>
				<div>
					<label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Google Cloud Project ID</label>
					<div class="flex gap-2 mb-3">
						<div class="relative flex-1">
							<select id="pid-select" name="project_id" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all appearance-none font-medium text-slate-700"></select>
							<i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
						</div>
						<button id="btn-refresh-pid" type="button" onclick="handleTokenChange(true)" class="px-4 py-3 text-indigo-600 hover:bg-indigo-50 border border-indigo-100 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="å¼ºåˆ¶åˆ·æ–°é¡¹ç›®åˆ—è¡¨"><i class="fa-solid fa-arrows-rotate"></i></button>
						<button id="btn-remove-pid" type="button" onclick="removePid()" class="px-4 py-3 text-red-500 hover:bg-red-50 border border-red-100 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="åˆ é™¤å½“å‰ID"><i class="fa-solid fa-trash"></i></button>
					</div>
					<div class="flex gap-2">
						<input type="text" id="new-pid-input" placeholder="è¾“å…¥æ–°çš„ Project ID" class="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all">
						<button id="btn-add-pid" type="button" onclick="addPid()" class="px-5 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl text-sm font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed">æ·»åŠ </button>
					</div>
				</div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">ç«¯å£</label>
                        <input type="number" name="port" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all font-mono font-medium">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">å¯†ç </label>
                        <input type="text" name="password" required value="123456" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all font-mono font-medium">
                    </div>
                </div>
                <div class="pt-6 flex justify-end gap-3 border-t border-slate-100 mt-6">
                    <button type="button" onclick="closeModal()" class="px-6 py-3 text-slate-600 hover:bg-slate-50 rounded-xl font-bold transition-colors">å–æ¶ˆ</button>
                    <button type="submit" class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all hover:-translate-y-0.5 active:translate-y-0">ä¿å­˜é…ç½®</button>
                </div>
            </form>
        </div>
    </div>

    <script>
		// --- å…¨å±€é…é¢é…ç½®è¡¨ ---
		const MODEL_QUOTA_MAP = {
			cli: {
				standard: { flash: 1000, pro: 100, default: 0 },
				pro:      { flash: 1500, pro: 250, default: 0 },
			},
			antigravity: {
				standard: { '2.5-flash': 3000, '2.5-flash-lite': 5000, '3-flash': 400, '3-pro': 75, '3-pro-image': 20, 'gpt-oss': 150, 'rev19-uic3-1p': 500, claude: 150, default: 0 },
				pro:      { '2.5-flash': 3000, '2.5-flash-lite': 5000, '3-flash': 400, '3-pro': 320, '3-pro-image': 20, 'gpt-oss': 150, 'rev19-uic3-1p': 500, claude: 150, default: 0 },
			}
		};
		// --- æ¨¡å‹åˆå¹¶æ˜¾ç¤ºçŠ¶æ€ ---
		let isMergeEnabled = localStorage.getItem('gemini_merge_enabled') !== 'false';
		let quotaCache = {};
		// --- æ¨¡å‹åˆ†ç»„é…ç½®è¡¨ ---
		const MODEL_GROUPS = {
			cli: {
				"2.5-flash": ["2.0-flash", "2.5-flash", "2.5-flash-lite"],
				"3-flash": ["3-flash-preview"],
				"pro": ["2.5-pro", "3-pro-preview"],
			},
			antigravity: {
				"2.5-flash": ["gemini-2.5-flash", "gemini-2.5-flash-thinking"],
				"2.5-flash-lite": ["gemini-2.5-flash-lite"],
				"3-flash": ["gemini-3-flash"],
				"3-pro": ["gemini-3-pro-low", "gemini-3-pro-high"],
				"image": ["gemini-3-pro-image"],
				"claude": ["claude-sonnet-4-5", "claude-sonnet-4-5-thinking", "claude-opus-4-5-thinking", "gpt-oss-120b-medium"],
				"rev19-uic3-1p": ["rev19-uic3-1p"],
			}
		};
		// --- é¢åº¦æ˜¾ç¤ºæ ·å¼é…ç½®è¡¨ ---
		const QUOTA_STYLE_CONFIG = {
			'flash':    { icon: 'fa-bolt',   color: 'text-amber-500',  bg: 'bg-amber-50' },
			'pro':      { icon: 'fa-star',   color: 'text-indigo-500', bg: 'bg-indigo-50' },
			'image':    { icon: 'fa-image',  color: 'text-pink-500',   bg: 'bg-pink-50' },
			'claude':   { icon: 'fa-ghost',  color: 'text-orange-500', bg: 'bg-orange-50' },
			'thinking': { icon: 'fa-brain',  color: 'text-blue-500',   bg: 'bg-blue-50' },
			'gpt':    	{ icon: 'fa-gem',    color: 'text-purple-600', bg: 'bg-purple-50' },
			'default':  { icon: 'fa-cube',   color: 'text-slate-400',  bg: 'bg-slate-50' } // é»˜è®¤
		};
		
		// --- è¾…åŠ©å·¥å…· ---
		const $ = id => document.getElementById(id);
		const $$ = sel => document.querySelectorAll(sel);
		const toggleClass = (el, className, force) => el?.classList.toggle(className, force);
		// é¡µé¢åŠ è½½ååˆå§‹åŒ–å¼€å…³çŠ¶æ€
		window.addEventListener('DOMContentLoaded', () => {
			const toggle = $('merge-toggle');
			if (toggle) toggle.checked = isMergeEnabled;
		});

		let currentType = 'cli', currentServers = [], currentProjectIds = [], sortableInstance = null, editId = null;
		let projectCache = JSON.parse(localStorage.getItem('gemini_project_cache') || '{}');

		const updateProjectCache = (key, data) => {
			if(key) { projectCache[key] = data; localStorage.setItem('gemini_project_cache', JSON.stringify(projectCache)); }
		};

        window.addEventListener('DOMContentLoaded', () => loadServers());

		function switchTab(tab) {
			$$('.tab-btn').forEach(b => {
				const isActive = b.id === `tab-${tab}`;
				b.classList.toggle('active', isActive);
				b.classList.toggle('text-indigo-600', isActive);
				b.classList.toggle('text-slate-500', !isActive);
			});
			['servers', 'quota'].forEach(v => toggleClass($(`view-${v}`), 'hidden', v !== tab));
			tab === 'servers' ? loadServers() : loadAllQuotas(false);
		}
		
		async function loginGoogle() {
			try {
				const res = await fetch(`/api/auth/url?type=${currentType}`);
				const data = await res.json();
				const authWin = window.open(data.url, 'GoogleLogin', 'width=600,height=700');
				const timer = setInterval(async () => {
					if (authWin.closed) { clearInterval(timer); await loadTokens($('token-select').value); handleTokenChange(); }
				}, 1000);
			} catch (e) { alert("å¯åŠ¨ç™»å½•å¤±è´¥: " + e.message); }
		}
		
		function toggleMerge(enabled) {
			isMergeEnabled = enabled;
			localStorage.setItem('gemini_merge_enabled', enabled);
			
			Object.keys(quotaCache).forEach(sid => {
				const listContainer = $(`quota-list-${sid}`);
				const acc = quotaCache[sid];
				if (listContainer && acc && acc.status !== 'error') {
					const groups = getDisplayGroups(acc.quotas, acc.type, isMergeEnabled);
					listContainer.innerHTML = groups.map(g => renderQuotaItem(g, acc.is_pro, acc.type)).join('');
					listContainer.classList.toggle('h-[320px]', isMergeEnabled);
					listContainer.classList.toggle('h-[430px]', !isMergeEnabled);
				}
			});
		}
		
		function handleTypeChange() {
			document.getElementsByName('type').forEach(t => { if(t.checked) currentType = t.value; });
			$('token-path-label').innerText = `å‡­è¯æ–‡ä»¶ (tokens/${currentType}/)`;
			currentProjectIds = [];
			renderPidSelect(); 
			loadTokens();
		}
		
		function setFormLock(locked) {
			const selectors = 'input[name="type"], #token-select, #btn-login-google, [id*="pid"], #new-pid-input, button[type="submit"]';
			$$(selectors).forEach(el => {
				el.disabled = locked;
				el.closest('div')?.classList.toggle('opacity-60', locked);
			});
		}
		async function handleTokenChange(forceRefresh = false) {
			const tokenFile = $('token-select').value;
			const pidSelect = $('pid-select');
			const refreshBtn = $('btn-refresh-pid');

			if (!tokenFile) {
				currentProjectIds = []; renderPidSelect();
				setFormLock(true); 
				$('token-select').disabled = false;
				$('btn-login-google').disabled = false;
				$$('input[name="type"]').forEach(r => r.disabled = false);
				return;
			}

			const cacheKey = `${tokenFile}_${currentType}`;
			if (!forceRefresh && projectCache[cacheKey]?.length > 0) {
				currentProjectIds = projectCache[cacheKey];
				renderPidSelect(pidSelect.value);
				setFormLock(false);
				return;
			}
			
			// --- å¼€å§‹è¯·æ±‚ï¼šå…¨é”å®š ---
			setFormLock(true); 
			refreshBtn.querySelector('i').classList.add('animate-spin');
			pidSelect.innerHTML = '<option value="">ğŸ” æ­£åœ¨æ¢æµ‹é¡¹ç›®...</option>';
			
			try {
				const res = await fetch(`/api/tokens/${tokenFile}/projects?type=${currentType}`);
				if (!res.ok) throw new Error();
				
				currentProjectIds = await res.json();
				updateProjectCache(cacheKey, currentProjectIds);
				renderPidSelect(currentProjectIds[0]?.id);
			} catch (e) {
				pidSelect.innerHTML = '<option value="">âŒ è·å–å¤±è´¥</option>';
			} finally {
				// --- è¯·æ±‚ç»“æŸï¼šå…¨è§£é” ---
				setFormLock(false);
				refreshBtn.querySelector('i').classList.remove('animate-spin');
			}
		}
		
		function renderPidSelect(selectedId) {
			const select = $('pid-select');
			currentProjectIds = currentProjectIds.filter(p => p?.id?.trim() && !p.id.includes('âŒ'));
			const typePriority = { 'internal': 0, 'generated': 1, 'cloud': 2, 'custom': 3 };
			currentProjectIds.sort((a, b) => (typePriority[a.type] ?? 99) - (typePriority[b.type] ?? 99));
			select.innerHTML = currentProjectIds.map(item => {
				let display = item.id;
				if (item.type === 'internal')  display = `â˜… ${item.id} (CLIå†…æµ‹)`;
				else if (item.type === 'generated') display = `ğŸ² ${item.id} (éšæœºç”Ÿæˆ)`;
				else if (item.type === 'cloud') display = `â˜ï¸ ${item.id}`;
				return `<option value="${item.id}" ${item.id === selectedId ? 'selected' : ''}>${display}</option>`;
			}).join('');
		}

		function addPid() {
			const input = $('new-pid-input'), 
				  tokenFile = $('token-select').value,
				  val = input.value.trim();
			if (val && tokenFile) {
				if (!currentProjectIds.some(p => p.id === val)) {
					currentProjectIds.push({ id: val, type: 'custom' });
					updateProjectCache(`${tokenFile}_${currentType}`, currentProjectIds);
					renderPidSelect(val);
				}
				input.value = '';
			}
		}

		function removePid() {
			const val = $('pid-select').value,
				  tokenFile = $('token-select').value;
			if (val && tokenFile) {
				currentProjectIds = currentProjectIds.filter(item => item.id !== val);
				updateProjectCache(`${tokenFile}_${currentType}`, currentProjectIds);
				renderPidSelect(currentProjectIds[0]?.id);
			}
		}

        async function loadServers() {
            const res = await fetch('/api/servers');
            currentServers = await res.json();
			currentServers.forEach(s => { if (s.token_file && s.project_ids?.length) updateProjectCache(`${s.token_file}_${s.type || 'cli'}`, s.project_ids); });
            const container = $('server-list');
            if (!currentServers.length) { container.innerHTML = `<div class="col-span-full text-center py-20 text-slate-400 bg-white rounded-2xl border border-dashed border-slate-300">æš‚æ— é…ç½®ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æœåŠ¡</div>`; return; }

            container.innerHTML = currentServers.map(s => {
                const isRun = s.status === 'running';
                return `
                <div class="card-enter bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 p-6 group relative" data-id="${s.id}">
                    <div class="flex justify-between items-start mb-5">
                        <div class="min-w-0 flex-1 mr-4">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-xl text-slate-900 truncate" title="${s.name}">${s.name}</h3>
                                ${s.is_pro ? '<span class="shrink-0 inline-flex items-center gap-1 rounded bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 px-2 py-0.5 text-[10px] font-bold text-white shadow-sm ring-1 ring-inset ring-purple-500/10">PRO</span>' : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-3 shrink-0">
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                <div class="handle cursor-grab w-7 h-7 rounded-lg hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors"><i class="fa-solid fa-grip-vertical text-sm"></i></div>
                                <button onclick='showModal("${s.id}")' class="w-7 h-7 rounded-lg hover:bg-indigo-50 flex items-center justify-center text-slate-400 hover:text-indigo-600 transition-colors"><i class="fa-solid fa-pen-to-square text-sm"></i></button>
                                <button onclick="deleteServer('${s.id}')" class="w-7 h-7 rounded-lg hover:bg-red-50 flex items-center justify-center text-slate-400 hover:text-red-600 transition-colors"><i class="fa-solid fa-trash text-sm"></i></button>
                            </div>
                            <span id="status-${s.id}" class="px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1.5 ${isRun?'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-500'}">
                                <span class="w-2 h-2 rounded-full ${isRun?'bg-emerald-500 animate-pulse':'bg-slate-400'}"></span>
                                <span class="status-text">${isRun ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}</span>
                            </span>
                        </div>
                    </div>
                    <div class="font-mono text-sm text-slate-500 space-y-3 mb-6">
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400 shrink-0 border border-slate-100"><i class="fa-brands fa-google text-xs"></i></div><span class="truncate font-medium select-all">${s.project_id}</span></div>
                        <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400 shrink-0 border border-slate-100"><i class="fa-solid fa-network-wired text-xs"></i></div><span class="font-semibold text-slate-600">${s.port}</span></div>
                    </div>
                    <button onclick="${isRun ? `stopServer('${s.id}')` : `startServer('${s.id}')`}" class="w-full py-3.5 rounded-xl font-bold text-sm transition-all flex items-center justify-center gap-2.5 active:scale-[0.98] ${isRun ? 'bg-rose-50 text-rose-600 hover:bg-rose-100' : 'bg-slate-900 text-white hover:bg-slate-800 shadow-lg shadow-slate-200'}">
                        <i class="fa-solid ${isRun ? 'fa-power-off' : 'fa-play'}"></i> ${isRun ? 'åœæ­¢æœåŠ¡' : 'å¯åŠ¨æœåŠ¡'}
                    </button>
                </div>`;
            }).join('');

            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(container, {
                handle: '.handle', animation: 150, ghostClass: 'sortable-ghost',
                onEnd: () => fetch('/api/servers/reorder', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(Array.from(container.children).map(el => el.getAttribute('data-id'))) })
            });
        }
		
		async function showModal(id = null) {
			editId = id;
			const form = $('server-form');
			form.reset();
			
			const isEdit = !!id;
			const s = isEdit ? currentServers.find(x => x.id === id) : { type: 'cli', port: '', password: '123456', project_ids: [] };
			
			$('modal-title').innerText = isEdit ? "ç¼–è¾‘é…ç½®" : "æ·»åŠ é…ç½®";
			document.getElementsByName('type').forEach(r => r.checked = (r.value === (s.type || 'cli')));
			handleTypeChange();

			if (isEdit) {
				['name', 'port', 'password'].forEach(key => { if(form[key]) form[key].value = s[key]; });
				currentProjectIds = s.project_ids || [];
				await loadTokens(s.token_file);
				renderPidSelect(s.project_id);
			}
			$('modal-add').classList.replace('hidden', 'flex');
		}

        async function loadTokens(selectedVal) {
			const res = await fetch(`/api/tokens?type=${currentType}`), tokens = await res.json(), select = $('token-select');
			select.innerHTML = tokens.map(t => `<option value="${t}" ${selectedVal===t?'selected':''}>${t}</option>`).join('');
			tokens.length > 0 ? handleTokenChange(false) : (currentProjectIds = [], $('pid-select').innerHTML = '');
		}

        function closeModal() { $('modal-add').classList.replace('flex', 'hidden'); }

		async function apiAction(url, options = {}, btn = null, refreshId = null) {
			const originalHTML = btn?.innerHTML;
			if (btn) { 
				btn.disabled = true; 
				btn.classList.add('opacity-50', 'pointer-events-none');
				btn.innerHTML = `<i class="fa-solid fa-circle-notch animate-spin"></i> å¤„ç†ä¸­...`; 
			}
			
			try {
				const res = await fetch(url, options);
				const text = await res.text();
				let data = {};
				try { data = text ? JSON.parse(text) : {}; } catch(e) { data = {}; }
				if (!res.ok) throw new Error(data.message || `è¯·æ±‚å¤±è´¥ (çŠ¶æ€ç : ${res.status})`);
				await loadServers();
				if (refreshId && $(`quota-card-${refreshId}`)) fetchQuota(refreshId);
				return data || { success: true };
			} catch (err) {
				alert(err.message);
				await loadServers();
				return null;
			} finally {
				if (btn) { 
					btn.disabled = false; 
					btn.classList.remove('opacity-50', 'pointer-events-none'); 
					btn.innerHTML = originalHTML; 
				}
			}
		}
		async function startServer(id) {
			const btn = event.currentTarget;
			const badge = $(`status-${id}`);
			if(badge) { 
				badge.className = "px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1.5 bg-amber-100 text-amber-700"; 
				badge.innerHTML = `<span class="w-2 h-2 rounded-full bg-amber-500 animate-ping"></span><span class="status-text">å¯åŠ¨ä¸­...</span>`; 
			}
			await apiAction(`/api/servers/${id}/start`, { method: 'POST' }, btn, id);
		}

		async function stopServer(id) {
			if (!confirm('ç¡®å®šåœæ­¢è¯¥æœåŠ¡å—ï¼Ÿ')) return;
			await apiAction(`/api/servers/${id}/stop`, { method: 'POST' }, event.currentTarget, id);
		}

		async function deleteServer(id) {
			if (!confirm('ç¡®å®šåˆ é™¤è¯¥é…ç½®å—ï¼Ÿ')) return;
			await apiAction(`/api/servers/${id}`, { method: 'DELETE' }, null);
			$(`quota-card-${id}`)?.remove();
		}
		
		async function handleFormSubmit(e) {
			e.preventDefault();
			const btn = e.target.querySelector('button[type="submit"]');
			const data = Object.fromEntries(new FormData(e.target).entries());
			
			data.project_id = $('pid-select').value;
			if (!data.project_id) return alert("è¯·é€‰æ‹© Project ID");
			
			data.port = parseInt(data.port);
			data.project_ids = currentProjectIds;

			const url = editId ? `/api/servers/${editId}` : '/api/servers';
			const method = editId ? 'PUT' : 'POST';

			const success = await apiAction(url, {
				method,
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data)
			}, btn, editId);

			if (success) closeModal();
		}

		function formatResetTime(iso) {
			const d = new Date(iso);
			if (isNaN(d)) return iso || '--:--:--';
			const time = d.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
			const diff = (new Date(d.toDateString()) - new Date(new Date().toDateString())) / 86400000;
			if (diff === 0) return `ä»Šå¤© ${time}`;
			if (diff === 1) return `æ˜å¤© ${time}`;
			return `${d.getMonth() + 1}.${d.getDate()} ${time}`;
		}
		
		function getModelMeta(modelId, fraction, isPro, type) {
			const id = modelId.toLowerCase();
			const config = (MODEL_QUOTA_MAP[type] || MODEL_QUOTA_MAP.cli)[isPro ? 'pro' : 'standard'];
			const findMatch = (map) => Object.keys(map).sort((a,b) => b.length - a.length).find(k => id.includes(k.toLowerCase())) || 'default';
			const qKey = findMatch(config);
			const sKey = findMatch(QUOTA_STYLE_CONFIG);
			return {
				total: config[qKey],
				remaining: Math.round(config[qKey] * (fraction > 0.9999 ? 1 : fraction)),
				style: QUOTA_STYLE_CONFIG[sKey]
			};
		}

		function renderQuotaItem(group, isPro, type) {
			const isMergedGroup = group.models.length > 1;
			const firstModel = group.models[0];
			const calc = getModelMeta(firstModel.modelId, firstModel.remainingFraction, isPro, type);
			const style = calc.style; 

			let barTheme = 'bg-emerald-500', textTheme = 'text-emerald-700';
			if (firstModel.remainingFraction < 0.2) { barTheme = 'bg-rose-500'; textTheme = 'text-rose-700'; }
			else if (firstModel.remainingFraction < 0.5) { barTheme = 'bg-amber-500'; textTheme = 'text-amber-700'; }
			
			let namesHtml = "";
			if (isMergedGroup) {
				namesHtml = `<div class="flex flex-col gap-1.5 mb-1">` + 
					group.models.map(m => {
						const name = m.modelId.replace('models/', '').replace('gemini-', '');
						return `<div class="text-base font-bold text-slate-800 capitalize leading-tight">${name}</div>`;
					}).join('') + `</div>`;
			} else {
				const name = firstModel.modelId.replace('models/', '').replace('gemini-', '');
				namesHtml = `<span class="text-base font-bold text-slate-800 capitalize leading-none pt-0.5">${name}</span>`;
			}

			return `
			<div class="py-1.5 border-b border-slate-100 last:border-0 last:pb-0 hover:bg-slate-50 -mx-4 px-4 rounded-lg transition-colors group/item">
				<div class="flex justify-between ${isMergedGroup ? 'items-start' : 'items-center'} mb-1">
					<div class="flex ${isMergedGroup ? 'items-start' : 'items-center'} gap-3">
						<div class="w-8 h-8 rounded-lg ${style.bg} border border-slate-200/50 flex items-center justify-center shadow-sm shrink-0 ${isMergedGroup ? 'mt-0.5' : ''}">
							<i class="fa-solid ${style.icon} ${style.color} text-sm"></i>
						</div>
						${namesHtml}
					</div>
					<div class="flex items-baseline gap-1.5">
						<span class="text-2xl font-extrabold ${textTheme} tabular-nums leading-none">${calc.remaining}</span>
						<span class="text-sm text-slate-400 font-semibold">/ ${calc.total}</span>
					</div>
				</div>
				<div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden mb-2">
					<div class="h-full rounded-full ${barTheme} transition-all duration-1000 shadow-sm" style="width: ${firstModel.remainingFraction*100}%"></div>
				</div>
				<div class="flex justify-between items-center">
					<div class="flex items-center gap-2 bg-slate-100 px-2 py-0.5 rounded text-slate-500">
						<span class="text-[10px] font-bold uppercase tracking-wider text-slate-400">FRAC</span>
						<code class="text-[13px] font-mono text-slate-600 font-bold select-all leading-tight">${firstModel.remainingFraction}</code>
					</div>
					<div class="flex items-center gap-1.5 text-[13px] font-medium text-slate-500">
						<i class="fa-regular fa-clock text-slate-400 text-xs"></i>
						<span>${formatResetTime(firstModel.resetTime)}</span>
					</div>
				</div>
			</div>`;
		}
		
		let isRefreshing = false;
		async function loadAllQuotas(force = false) {
			if (isRefreshing) return;
			const grid = $('quota-grid'), btn = document.querySelector('button[onclick="loadAllQuotas(true)"]'), oHTML = btn?.innerHTML;
			if (!currentServers.length) currentServers = await (await fetch('/api/servers')).json();
			const isInit = grid.children.length !== currentServers.length;
			if (force || isInit) { isRefreshing = true; if(btn){ btn.disabled = true; btn.innerHTML = `<i class="fa-solid fa-circle-notch animate-spin text-indigo-600"></i> åˆ·æ–°ä¸­...`; } }
			try {
				if (isInit) {
					grid.innerHTML = currentServers.map(s => `<div id="quota-card-${s.id}" class="animate-pulse bg-white rounded-2xl border p-6 h-64"></div>`).join('');
					await Promise.all(currentServers.map((s, i) => new Promise(r => setTimeout(async () => { await fetchQuota(s.id); r(); }, i*100))));
				} else if (force) await Promise.all(currentServers.map(s => fetchQuota(s.id)));
			} finally { if(force || isInit) { isRefreshing = false; if(btn){ btn.disabled = false; btn.innerHTML = oHTML; } } }
		}

        async function fetchQuota(id) {
			const card = $(`quota-card-${id}`);
			if (card) { card.classList.add('animate-pulse'); card.innerHTML = `<div class="p-6 h-64"></div>`; }
			try {
				const res = await fetch(`/api/servers/${id}/quota`);
				const data = await res.json();
				quotaCache[id] = data; // å­˜å…¥ç¼“å­˜
				const sInfo = currentServers.find(s => s.id === id);
				if (card) { 
					const temp = document.createElement('div'); 
					temp.innerHTML = createQuotaCard(data, sInfo?.status || 'stopped', id); 
					card.replaceWith(temp.firstElementChild); 
				}
			} catch (e) { 
				if(card) { card.classList.remove('animate-pulse'); card.innerHTML = `<div class="p-6 text-center text-red-500 font-bold">åŠ è½½å¤±è´¥</div>`; } 
			}
		}

		function getDisplayGroups(quotas, type, isMerge) {
			const filtered = quotas.filter(v => {
				const mid = v.modelId.toLowerCase();
				if (mid.match(/chat_/)) return false;
				// ä»…åœ¨ä¸åˆå¹¶æ—¶éšè— 2.0-flash
				if (!isMerge && mid.includes('2.0-flash')) return false;
				if (type === 'antigravity' && mid.includes('2.5-pro')) return false;
				return true;
			});
			if (!isMerge) return filtered.sort((a, b) => a.modelId.localeCompare(b.modelId)).map(q => ({ models: [q] }));
			const typeGroups = MODEL_GROUPS[type] || {};
			const allPatterns = [];
			Object.entries(typeGroups).forEach(([gn, ps]) => {
				ps.forEach(p => allPatterns.push({ pattern: p.toLowerCase(), groupName: gn }));
			});
			allPatterns.sort((a, b) => b.pattern.length - a.pattern.length);

			const groupMap = {}; // groupName -> models[]
			const ungrouped = [];
			
			filtered.forEach(q => {
				const mid = q.modelId.toLowerCase();
				const match = allPatterns.find(ap => mid.includes(ap.pattern));
				if (match) {
					if (!groupMap[match.groupName]) groupMap[match.groupName] = [];
					groupMap[match.groupName].push(q);
				} else {
					ungrouped.push(q);
				}
			});

			const result = [];
			Object.keys(typeGroups).forEach(gn => {
				if (groupMap[gn]) {
					const ps = typeGroups[gn];
					groupMap[gn].sort((a, b) => {
						const getRank = (mid) => ps.reduce((bestIdx, p, i) => 
							(mid.toLowerCase().includes(p.toLowerCase()) && p.length > (ps[bestIdx]?.length || 0)) ? i : bestIdx, 0);
						return getRank(a.modelId) - getRank(b.modelId);
					});
					result.push({ models: groupMap[gn] });
				}
			});
			
			ungrouped.sort((a, b) => a.modelId.localeCompare(b.modelId)).forEach(q => result.push({ models: [q] }));
			return result;
		}
        function createQuotaCard(acc, status, sid) {
			if(acc.status === 'error') return `<div id="quota-card-${sid}" class="bg-white rounded-2xl p-6 border border-red-100 flex items-start gap-4"><div class="w-12 h-12 rounded-xl bg-red-50 flex items-center justify-center text-red-500 shrink-0"><i class="fa-solid fa-triangle-exclamation"></i></div><div><h3 class="font-bold text-slate-900">${acc.filename}</h3><p class="text-red-600 text-sm mt-1">${acc.message}</p></div></div>`;
			const { user, quotas, config_name, is_pro, type } = acc;
			const sInfo = currentServers.find(s => s.id === sid);
			const typeBadge = `<span class="inline-flex items-center rounded-md ${type==='antigravity'?'bg-purple-50 text-purple-700 ring-purple-700/10':'bg-blue-50 text-blue-700 ring-blue-700/10'} px-2 py-1 text-xs font-medium ring-1 ring-inset ml-2">${type.toUpperCase()}</span>`;
			const displayGroups = getDisplayGroups(quotas, type, isMergeEnabled);
			return `
			<div id="quota-card-${sid}" class="card-enter bg-white rounded-3xl border border-slate-200 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col overflow-hidden">
				<div class="flex items-center justify-between px-5 py-2 bg-slate-50/80 border-b border-slate-100">
					<div class="flex items-center min-w-0"><i class="fa-solid fa-server text-[9px] text-slate-400 mr-1.5"></i><span class="text-[10px] font-black text-slate-500 uppercase truncate max-w-[100px]">${config_name}</span>${typeBadge}</div>
					<div class="flex items-center gap-1.5 bg-white/60 px-2 py-0.5 rounded border border-slate-200/50 shrink-0 ml-2"><i class="fa-brands fa-google text-[9px] text-slate-400"></i><span class="text-[10px] font-bold font-mono text-slate-500 select-all">${sInfo?.project_id || 'Unknown'}</span></div>
				</div>
				<div class="px-5 py-2.5 flex items-center gap-3.5">
					<div class="relative shrink-0">
						<img src="${user.picture}" referrerpolicy="no-referrer" class="w-12 h-12 rounded-xl shadow-sm border-2 border-white object-cover">
						<div class="absolute -bottom-1 -right-1 w-3.5 h-3.5 ${status==='running'?'bg-emerald-500 animate-pulse':'bg-slate-300'} border-[3px] border-white rounded-full shadow-sm"></div>
					</div>
					<div class="min-w-0 flex-1">
						<div class="flex items-center leading-none mb-1">
							<h3 class="font-extrabold text-slate-900 text-base truncate">${user.name}</h3>
							${is_pro?'<span class="inline-flex items-center rounded bg-indigo-600 px-1.5 py-0.5 text-[10px] font-black text-white ml-2 shadow-sm">PRO</span>':''}
						</div>
						<div class="flex items-center gap-1 text-slate-400 text-xs">
							<i class="fa-regular fa-envelope text-[9px]"></i>
							<span class="truncate font-medium">${user.email}</span>
						</div>
					</div>
				</div>
				<div class="px-5 pb-4 flex-1 flex flex-col">
					<div class="h-px bg-slate-100 w-full"></div>
					<div id="quota-list-${sid}" class="space-y-0.5 ${isMergeEnabled ? 'h-[320px]' : 'h-[430px]'} overflow-y-auto overflow-x-hidden pr-1 custom-scrollbar">
						${displayGroups
							.map(g => renderQuotaItem(g, is_pro, type))
							.join('') || '<div class="py-4 text-center text-slate-400 text-sm italic">æš‚æ— é…é¢æ•°æ®</div>'}
					</div>
				</div>
			</div>`;
		}
	</script>
</body>
</html>